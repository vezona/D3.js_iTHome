---
title: 圓餅圖 Pie chart
layout: ./app/layout.ejs
engine: ejs
current: Helper Functions
---

<style>

.chartContainer {
    margin: auto;
    width: 80%;
    min-width: 200px;
    /* height: 600px; */
    margin: auto;
}

polyline{
    opacity: .3;
    stroke: black;
    stroke-width: 2px;
    fill: none;
}
</style>
<h2 class="text-center fw-bold">圓餅圖</h2>
<div class="chartContainer"></div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>

  // Data
  // const data = [{city:'台北', data:30},{city:'新北', data:45},
  //           {city:'台中', data:9},{city:'嘉義', data:67},{city:'台南', data:22}]; 

  // 台灣各縣市用電資料  https://www.taipower.com.tw/tc/page.aspx?mid=5554
  let data = []
  async function getData() {
    dataGet = await d3.csv('./data/202107_Electric.csv');
    console.log(dataGet);
    data = dataGet
    drawPie()
  };
  getData();


  // 開始畫圓餅圖 
  const drawPie = () => {
    // RWD 清除原本的圖型
    d3.select('svg').remove()

    // svg圖形區大小、邊界
    const svgWidth = parseInt(d3.select(".chartContainer").style("width")),
          svgHeight = svgWidth*0.8,
          margin = 40;

    // 先設定 svg 大小
    const svg = d3.select(".chartContainer")
                    .append("svg")
                    .attr("width", svgWidth)
                    .attr("height", svgHeight);

    // 圖表與線條、標籤
    svg.append("g")
			.attr("class", "slices")
      .attr('transform', `translate(${svgWidth / 2}, ${svgHeight / 2})`);
    svg.append("g")
      .attr("class", "labels");
    svg.append("g")
      .attr("class", "lines");

    // 圓餅圖的圓弧大小是區域的一半
    const radius = Math.min(svgWidth, svgHeight) / 2 - margin;

    // 設定顏色
    const color = d3.scaleOrdinal()
        .range(["#4BEFCF","#2c9af7","#F96262", '#910842', '#b054e5']);

    // 換算每個資料在圓餅圖上的大小:
    const piechart = d3.pie().value(d => {
              return parseInt(d['A.售電量(度)'].split(',').join('')) > 200000000
              });

    // innerRadius 跟 outerRadius 決定圓餅內圈外圈的大小 radius
    const arc = d3.arc().innerRadius(0).outerRadius(radius),
          outerArc = d3.arc()
                       .outerRadius(radius * 0.9)
                       .innerRadius(radius * 0.9),
          data_ready = piechart(data)

    // 建立pie
   const cutePie = svg.select('.slices')
        .selectAll('g')
        .data(data_ready)
        .enter()
        .append('g')
        .attr('class', 'arc')

    cutePie.append('path')
        .attr('d', arc)
        .attr('fill', color)
        .attr("stroke", "black")
        .style("stroke-width", "2px")
        .style("opacity", 1);
    
    // 加上每個區塊的標示
    // 控制文字的位置
    const arcText = d3.arc()
                      .innerRadius(radius)
                      .outerRadius(radius)

    const cityText = cutePie.append('text')
                            .attr('transform', d => `translate(${arcText.centroid(d)})`)
                            .text(d => {
                              if(parseInt(d.data['A.售電量(度)'].split(',').join('')) > 200000000){
                                return d.data['縣市']
                              }
                            })
                            .style('text-anchor', 'middle')
                            .attr('z-index', 2)
                            .style('font-size', 16)
                            .style('fill', 'black')
    
    // 滑鼠互動 mouseover、mouseleave
    d3.selectAll('.arc path')
      .style('cursor', 'pointer')
      .on('mouseover', function(){
         d3.select(this)
           .transition()
           .duration(500)
           .style("opacity", "0.5")
           .style('transform', 'scale(1.1)')
      })
      .on('mouseleave', function(){
        d3.select(this)
          .transition()
          .duration(500)
          .style('opacity', '1')
          .style('transform', 'scale(1)')
      })
  };

  // drawPie()

  // RWD
  d3.select(window).on("resize", drawPie);
     

</script>
