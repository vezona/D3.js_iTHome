<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* Add shadow effect to chart. If you don't like it, get rid of it. */
    svg {
        filter: drop-shadow( 0px 6px 6px rgba(0,0,0,.25) );
     }

    /*Styling for the lines connecting the labels to the slices*/
    polyline {
        opacity: .3;
        stroke: black;
        stroke-width: 2px;
        fill: none;
    }

    /* Make the percentage on the text labels bold*/
    .labelName tspan {
        font-style: normal;
        font-weight: 700;
    }

    /* In biology we generally italicise species names. */
    .labelName {
        font-size: 0.9em;
        font-style: italic;
    }
</style>
</head>

<body> 
  <script>
  // 撈資料
    // let data = []
    // async function getData() {
    //     dataGet = await d3.csv('./data/202107_Electric.csv');
    //     data = dataGet
        // drawPie()
    // };
    // getData();

    const drawPie = () => {
    var svg = d3.select("body").append("svg")
      .attr("width", 960)
      .attr("height", 500)
      .append("g");

    // 圓餅、線段、標籤
    svg.append("g")
			.attr("class", "slices");
    svg.append("g")
      .attr("class", "labels");
    svg.append("g")
      .attr("class", "lines");

    var width = 500;
    var height = 400;
    // radius設定圓餅圖的圓弧大小，是區域的一半
    var radius = Math.min(width, height)/2;
    
    // 設定顏色
    const color = d3.scaleOrdinal()
                    .range(["#4BEFCF","#2c9af7","#F96262", '#910842', '#b054e5']);
    
    var data = [{city:'台北', data:30},{city:'新北', data:45},
            {city:'台中', data:9},{city:'嘉義', data:67},{city:'台南', data:22}]    
    

    
    var pie = d3.pie().sort(null).value(d => d.data);
    var arc = d3.arc().innerRadius(radius*0.3).outerRadius(radius*0.6);
    
    var outerArc = d3.arc()
                .outerRadius(radius * 0.9)
                .innerRadius(radius * 0.9);
     
    svg.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
    
    svg.selectAll('path')
    .data(pie(data))
    .enter()
    .append('path')
  	.attr('d', arc)
    .attr('fill', (d,i)=> color(i));
    svg.append('g').classed('labels',true);
    svg.append('g').classed('lines',true);
     

    var polyline = svg.select('.lines')
                .selectAll('polyline')
                .data(pie(data))
                .enter()
                .append('polyline')
                .attr('points', function(d) {
                    // see label transform function for explanations of these three lines.
                    var pos = outerArc.centroid(d);
                    pos[0] = radius * 0.95 * (midAngle(d) < Math.PI ? 1 : -1);
                    return [arc.centroid(d), outerArc.centroid(d), pos]
                });
	
    var label = svg.select('.labels').selectAll('text')
                .data(pie(data))
            .enter().append('text')
                .attr('dy', '.35em')
                .html(function(d) {
                        return `${d.data.city}：${d.data.data}萬度`
                })
                .attr('transform', function(d) {
                    var pos = outerArc.centroid(d);
                    pos[0] = radius * 0.95 * (midAngle(d) < Math.PI ? 1 : -1);
                    return 'translate(' + pos + ')';
                })
                .style('text-anchor', function(d) {
                    return (midAngle(d)) < Math.PI ? 'start' : 'end';
                });
    
     svg.append('text')
                        .attr('class', 'toolCircle')
                        .attr('dy', 0) // hard-coded. can adjust this to adjust text vertical alignment in tooltip
                        .html('用電量') // add text to the circle.
                        .style('font-size', '.9em')
                        .style('text-anchor', 'middle');
    
    function midAngle(d) { return d.startAngle + (d.endAngle - d.startAngle) / 2; } 

    }

    drawPie();
    
    
  </script> 
</body>